<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Prochains RER – Viry-Châtillon</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #result { margin-top: 20px; }
  </style>
</head>
<body>

<h2>Prochains RER C – Gare de Viry-Châtillon</h2>
<div id="result">Chargement…</div>

<script>
// === CONFIGURATION ===
const API_KEY = "7y6UbPM2nv9RWlmqfQ0waaazmH0ri5Im";

// URL IDFM GTFS-RT trip updates
const IDFM_URL =
  "https://prim.iledefrance-mobilites.fr/marketplace/gtfs-rt-trip-updates/v2/gtfs-rt-trip-updates?key=" +
  API_KEY;

// Ton proxy Render
const PROXY_URL =
  "https://cors-c39h.onrender.com/proxy?url=" + encodeURIComponent(IDFM_URL);

// Stop ID de Viry-Châtillon (direction Paris)
const STOP_ID = "stop_point:OCETrainPSL-8738190";

async function loadData() {
  try {
    const response = await fetch(PROXY_URL);
    if (!response.ok) throw new Error("Erreur API");

    const buffer = await response.arrayBuffer();
    const feed =
      window.GtfsRealtimeBindings.transit_realtime.FeedMessage.decode(
        new Uint8Array(buffer)
      );

    let upcoming = [];

    feed.entity.forEach((entity) => {
      if (entity.tripUpdate) {
        entity.tripUpdate.stopTimeUpdate.forEach((update) => {
          if (
            update.stopId === STOP_ID &&
            update.arrival &&
            update.arrival.time
          ) {
            const ts = Number(update.arrival.time);
            if (!isNaN(ts)) upcoming.push(ts * 1000);
          }
        });
      }
    });

    upcoming.sort((a, b) => a - b);

    if (upcoming.length === 0) {
      document.getElementById("result").innerText = "Aucun train à venir.";
      return;
    }

    let html = "<ul>";
    upcoming.slice(0, 5).forEach((t) => {
      html += "<li>" + new Date(t).toLocaleTimeString("fr-FR") + "</li>";
    });
    html += "</ul>";

    document.getElementById("result").innerHTML = html;
  } catch (e) {
    document.getElementById("result").innerText = "Erreur : " + e.message;
  }
}

loadData();
setInterval(loadData, 30000);
</script>

<script src="https://cdn.jsdelivr.net/npm/gtfs-realtime-bindings@latest/browser/gtfs-realtime.js"></script>

</body>
</html>
